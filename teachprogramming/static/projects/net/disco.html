<script type="module">
// use with https://github.com/calaldees/channelServer

const urlParams = new URLSearchParams(window.location.search)
const WS_URL = urlParams.get('ws_url') || "ws://localhost:9800/test1.ws"
const ID = urlParams.get('id')
// For transmitting sequence
const BPM = parseInt(urlParams.get('bpm') || 60)
const IDS = parseInt(urlParams.get('ids') || 8)


function randomByte() {return Math.floor(Math.random()*255)}
function updateScreenColor(r,g,b) {
    r = r || randomByte()
    g = g || randomByte()
    b = b || randomByte()
    document.body.style = `background-color: rgb(${r},${g},${b});`
}

/*
function randomByte() {return Math.floor(Math.random()*255)}
function updateScreenColor(r,g,b) {
    arguments = arguments.map((v)=>v>=0?v:randomByte());
    document.body.style = `background-color: rgb(${arguments.join(',')});`
}
*/



// Keyboard event
window.addEventListener('keydown', (event)=>{
    updateScreenColor()
})

// Websocket event
const socket = new WebSocket(WS_URL);
window.socket = socket
socket.addEventListener('message', (event)=>{
    //console.log(event.data);
    if (!ID) {updateScreenColor(); return;}

    const messages = event.data.split('\n')
    for (let message of messages) {
        const [id, r, g, b] = message.split(":")
        if (ID == id) {
            updateScreenColor(r,g,b)
        }
    }
})

// -----------------------------------------------------------------------------

const COLORS = [
    [255,0,0], //red
    [255,255,0], //yellow
    [0,255,0], // green
    [0,255,255], // cyan
    [0,0,255], // blue
    [255,0,255], // magenta
]
export function* range(target, start=0, step=1) {for (let i=start ; i<target ; i+=step) {yield i}}

function generate_disco_message_for_frame(frame) {
    const bar = Math.floor(frame/8)
    return [...range(IDS)].map((id)=>{
        const id_offset = (id+frame)%4==0?1:0
        const COLOR = COLORS[(bar + id_offset) % COLORS.length]
        return [id,].concat(COLOR).join(":")
    }).join("\n")
}

// this is a terrible timing loop as it drifts
const sleep = (milliseconds) => new Promise((resolve, reject) => setTimeout(resolve, milliseconds))
async function call_on_bpm(bpm, call) {
    const wait_in_milliseconds = (bpm / 60) * 1000;
    for (let frame=0 ; frame <= bpm ; frame++) {
        call(frame)
        await sleep(wait_in_milliseconds)
    }
}

function start_disco() {
    call_on_bpm(BPM, (frame)=>{
        const msg = generate_disco_message_for_frame(frame)
        console.log(msg)
        socket.send(msg)
    })
}

window.start_disco = start_disco


</script>