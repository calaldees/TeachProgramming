<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <link id="favicon" rel="shortcut icon" type="image/png" href="data:image/png;base64,....==" />
    <title>Map</title>

    <style>
        img, canvas {
            width: 100%; height: 100%;
            position: absolute; top: 0; left: 0;
            filter: blur(0.0em);
            transition: filter 3s ease-out;
        }
        img {
            object-fit: none;  /* contain, fill */
        }
        .disabled img, .disabled canvas {
            /* opacity: 0; */
            filter: blur(2em);
        }
    </style>
</head>
<body class=""><!-- class="disabled" -->
    <h1>Map</h1>
<script type="module">
import { build_transform_point_function } from './cord_translate.js'
import { SpeechRecognitionWrapper } from './SpeechRecognitionWrapper.js'


const urlParams = new URLSearchParams(window.location.search);
const name = urlParams.get('name') || "Unknown"
const websocket_url = urlParams.get('websocket_url') || `${window.location.protocol.startsWith("https")?"wss":"ws"}://${window.location.host}/ws`

const img_map = document.createElement('img')
document.body.appendChild(img_map)
img_map.src = urlParams.get('map') || "static/map.png"


const canvas = document.createElement('canvas')
document.body.appendChild(canvas)
canvas.width = window.innerWidth
canvas.height = window.innerHeight
const ctx = canvas.getContext('2d')


export function* enumerate(iterable) {
    let count = 0
    for (let item of iterable) {yield [count++, item]}
}


const translate_geopos_to_imgpos = build_transform_point_function(
    [[  0,  0],[100,  0],[100,100],[  0,100]],
    [[  0,  0],[200,  0],[200,200],[  0,200]],
)

// Connect WebSocket -----------------------------------------------------------

const socket = new WebSocket(websocket_url)

// Send WebSocket GeoPos -------------------------------------------------------

let message_count = 0
const watchID = navigator.geolocation.watchPosition((position) => {
    console.log("watchPosition", position.coords.latitude, position.coords.longitude)
    if (socket.readyState!=1) {return}
    socket.send(JSON.stringify({
        name,
        lat:position.coords.latitude,
        lon:position.coords.longitude,
        count:message_count++
    }))
})

// Receive WebSocket GeoPos ----------------------------------------------------

function draw_names_at_geopos_data(data) {
    ctx.clearRect(0, 0, canvas.width, canvas.height)
    for (let [name, location_list] of Object.entries(data)) {
        for (let [i, location] of enumerate(location_list)) {
            const [x, y] = translate_geopos_to_imgpos([location.lat, location.lon])
            // ctx.fillStyle = 'red'  // TODO: transparent the higher i is
            ctx.fillRect(x, y, 8,8)
            if (i==0) {  // Draw name above first location
                ctx.font = "16px serif"
                ctx.fillText(name, x, y-16)
            }
        }
    }
}

socket.addEventListener("message", (msg)=>{
    const data = JSON.parse(msg.data)
    //console.log("websocket", data)
    draw_names_at_geopos_data(data)
})


// Speech ----------------------------------------------------------------------

const toggle_map = () => body.classList.toggle("disabled")

const phrases = [
    {'keywords': ["I", "solemnly", "swear", "up", "no", "good"], 'func': toggle_map},
    {'keywords': ["mischief", "managed"], 'func': toggle_map}
]
SpeechRecognitionWrapper(phrases)

</script>
</body>
</html>