<!DOCTYPE html><html>
<head>
    <meta charset="utf-8" />
    <link id="favicon" rel="shortcut icon" type="image/png" href="data:image/png;base64,....==" />
    <title>Project</title>

    <style>
        .add {color: green;}
        .remove {color: red; text-decoration: line-through;}
        .lineNum {user-select: none;}
    </style>

</head>
<body>
<h1>Projects</h1>
<div id="main"></div>
<script type="module">

// core.js
// https://github.com/calaldees/libs/blob/9a7dbeea6d34240e13e9d684a8388519bb00885c/es6/core.js#L455
const hasIterationProtocol = variable => variable !== null && Symbol.iterator in Object(variable)
function h(type, params, children) {
    const el = document.createElement(type)
    for (let [k,v] of Object.entries(params)) {el[k] = v}
    if      (typeof(children)==="string"   ) {el.appendChild(document.createTextNode(children))}
    else if (hasIterationProtocol(children)) {for (let c of children) {el.append(c)}}
    else if (children                      ) {el.appendChild(children)}
    return el
}



const QUERY_STRING_project = 'project';
const urlParams = new URLSearchParams(window.location.search);
const hostElement = document.getElementById('main') || document.getElementsByTagName('body').item(0);


function renderProjectList(projects) {
    function _hrefProject(project) {
        const _urlParams = new URLSearchParams(urlParams)
        _urlParams.append(QUERY_STRING_project, project)
        return `${window.location.pathname}?${_urlParams.toString()}`
    }
    return h('div', {}, projects.map(project=>h('li',{},h('a',{href: _hrefProject(project)},project))))
}

function renderProject(data) {
    return h('div',{},Object.keys(data.languages).map(language=>[
        h('h2',{},language),
        ...Object.entries(data.versions.parents).map(([version, parent_version])=>[
            h('h3',{},version),
            h('pre',{classList: 'diff'}, renderDiff(data.diffs[language][version])),
            h('pre',{classList: 'full'}, data.languages[language][version]),
        ]).flat()
    ]).flat())
}

const REGEX_DIFF_SEGMENT = /@@ (?<back>[-+]\d+,\d+) (?<forward>[-+]\d+,\d+) @@\n(?<code>.*?)(?=$|\n@@)/sg
function renderDiff(diff) {
    if (!diff) {return}
    //for (let dd of diff.matchAll(REGEX_DIFF_SEGMENT)) {}
    function renderDiffSub(code_segment, lineNums) {
        console.log(lineNums)
        return h('code',{},code_segment.split("\n").map(line=>[
            h('span',{className:"lineNum"},"100 "),
            h('span',{className:[
                "line",
                line.startsWith("+")?"add":"",
                line.startsWith("-")?"remove":"",
            ].filter(x=>x).join(" ")},line+"\n"),
        ]).flat())
    }
    return [...diff.matchAll(REGEX_DIFF_SEGMENT)].map(match=>renderDiffSub(match.groups.code, match.groups.forward))
}

// Consider CSS toggle
//  https://blog.logrocket.com/advanced-guide-css-toggle-pseudo-class/

if (urlParams.has(QUERY_STRING_project)) {
    fetch(`/api/v1/projects/${urlParams.get(QUERY_STRING_project)}.json`)
        .then(response => response.json())
        .then(data=>hostElement.appendChild(renderProject(data)))
    .catch(err => console.error(err))
} else {
    fetch('/api/v1/projects.json')
        .then(response => response.json())
        .then(data=>hostElement.appendChild(renderProjectList(data.projects)))
    .catch(err => console.error(err))
}

</script></body></html>