<!DOCTYPE html><html>
<head>
    <meta charset="utf-8" />
    <link id="favicon" rel="shortcut icon" type="image/png" href="data:image/png;base64,....==" />
    <title>Project</title>


</head>
<body>
<h1>Projects</h1>
<div id="main"></div>
<script type="module">

// core.js
// https://github.com/calaldees/libs/blob/9a7dbeea6d34240e13e9d684a8388519bb00885c/es6/core.js#L455
const hasIterationProtocol = variable => variable !== null && Symbol.iterator in Object(variable)
function h(type, params, children) {
    const el = document.createElement(type)
    for (let [k,v] of Object.entries(params)) {el[k] = v}
    if      (typeof(children)==="string"   ) {el.appendChild(document.createTextNode(children))}
    else if (hasIterationProtocol(children)) {for (let c of children) {el.append(c)}}
    else if (children                      ) {el.appendChild(children)}
    return el
}



const QUERY_STRING_project = 'project';
const urlParams = new URLSearchParams(window.location.search);
const hostElement = document.getElementById('main') || document.getElementsByTagName('body').item(0);


function renderProjects(data) {
    const projects = data.projects;
    const elementContainer = document.createElement('div');
    for (const project of projects) {
        const _urlParams = new URLSearchParams(urlParams);
        _urlParams.append(QUERY_STRING_project, project);
        elementContainer.insertAdjacentHTML('beforeend', `<li><a href="${window.location.pathname}?${_urlParams.toString()}">${project}</a></li>`);
    }
    hostElement.appendChild(elementContainer);
}

function renderProject(data) {
    const e = hostElement;
    for (const [language, _version_code] of Object.entries(data.languages)) {
        e.insertAdjacentHTML('beforeend', `<h2>${language}</h2>`);
        if (!_version_code) {continue;}
        let prev = '';  // Dirty Dirty Hack - always diff previous version (and hope they are in the correct order)
        for (const [version, code] of Object.entries(_version_code)) {
            //const diff = Diff.createTwoFilesPatch("file", "file", prev, code)
            //const diff = patienceDiffStr(prev, code)  // This is currently not in the right format for diff2html to display - consider moving to manual rendering/styling of this diff

            hostElement.insertAdjacentHTML('beforeend', `<h3>${version}</h3>`)
            const pre = document.createElement('pre')
            pre.append(document.createTextNode(code))
            //pre.append("\n\n")
            //pre.append(document.createTextNode(diff))
            hostElement.append(pre);

            /*
            const div = document.createElement('div')
            hostElement.append(div)
            const diff2htmlUi = new Diff2HtmlUI(div, diff,{ drawFileList: true, matching: 'lines' })
            diff2htmlUi.draw()
            */

            prev = code; // DIRTY! DIRTY HACK!
        }
    }
}

if (urlParams.has(QUERY_STRING_project)) {
    fetch(`/api/v1/projects/${urlParams.get(QUERY_STRING_project)}.json`)
        .then(response => response.json())
        .then(renderProject)
    .catch(err => console.error(err))
} else {
    fetch('/api/v1/projects.json')
        .then(response => response.json())
        .then(renderProjects)
    .catch(err => console.error(err))
}

</script></body></html>